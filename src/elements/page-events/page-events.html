<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../dialog-event/dialog-event.html">

<dom-module id="page-events">
  <style is="custom-style">
    h3 {
      text-align: center;
    }
    #container {
      margin: 0 auto;
      height: 300px;
      width: 300px;
      overflow: hidden;
      background-color: #eee;
    }
    .calendar-container {
      margin: 0 auto;
      height: 300px;
      width: 300px;
      overflow: hidden;
      background-color: #eee;
    }
    app-drawer{
      --app-drawer-width: auto;
      margin-top: 64px;
    }
    .card-row {
      text-align: center;
      padding: 10px;
    }
    paper-card {
      width: 100%;
    }
    .fab-event {
      margin: 20px;
      position: fixed;
      bottom: 0;
      right: 0;
    }
    
    .no-events {
      display: -webkit-box;
      display: -webkit-flex;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-align: center;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;
      min-height: 24em;
      -webkit-box-pack: center;
      -webkit-justify-content: center;
      -ms-flex-pack: center;
      justify-content: center;
    }
    
    .no-events-icon {
      color: #E0E0E0;
      width: 25%;
      height: auto;
      max-width: 200px;
    }
    
    
    @media (min-width: 640px) {
      .fab-event {
        right: 300px;
      }
    }
  </style>
  
  <template>
    <firebase-collection
      order-by-child="start"
      limit-to-first="30"
      location="{{listLocation}}"
      data="{{events}}"
      id="eventCollection">
    </firebase-collection>
    <app-drawer-layout>
      <app-drawer id="calendarDrawer" align="end">
        <section>
          <div class="calendar-container">
            <paper-calendar id="calendar" date="{{date}}"></paper-calendar>
          </div>
        </section>
      </app-drawer>
      <app-header-layout>
        <section hidden$="{{hasNoEvents(events.*)}}">
          <template is="dom-repeat" items="[[events]]" as="event">
            <div class="card-row">
              <paper-card heading="[[event.title]]" data-key="[[event.__firebaseKey__]]">
                <div class="card-content">
                   <span>[[event.start]]</span>
                </div>
                <div class="card-actions">
                  <paper-button>Share</paper-button>
                  <a href$="/event/{{event.id}}" tabindex="-1">
                    <paper-button>Explore!</paper-button>
                  </a>
                </div>
              </paper-card>
            </div>
          </template>
        </section>
        <section hidden$="{{hasEvents(events.*)}}" class="no-events">
          <iron-icon class="no-events-icon" icon="event"></iron-icon>
          <h3>No events created</h3>
        </section>
        <paper-fab noink icon="add" title="Add Event" class="fab-event" data-dialog="eventDialog" on-tap="handleOpenDialog"></paper-fab>
      </app-header-layout>
    </app-drawer-layout>
    <iron-signals on-iron-signal-logout="handleLogout"></iron-signals>
    <iron-signals on-iron-signal-login-success="handleLogin"></iron-signals>
    <dialog-event></dialog-event>
  </template>
  
  <script>
    Polymer({
      is: 'page-events',
      listeners: {
        'create': 'handleCreateEvent'
      },
      properties: {
        date: {
          type: Date,
          notify: true
        },
        events: {
          type: Array,
          value: []
        },
        listLocation: {
          type:String,
          value:''
        }
      },
      
      ready: function() {
        this.async(function(){
          window.dispatchEvent(new Event('resize'));
        }, 1000);
      },
      
      handleLogin: function(event) {
        this.listLocation = 'https://u-swd-p1.firebaseio.com/events/' + event.detail.user.uid + '/list';
      },
      
      handleLogout: function(event) {
        this.listLocation = '';
      },
      
      /**
       * Open a dialog using the current target or it's parent 'data-dialog' attribute
       *
       */
      handleOpenDialog: function(e) {
        var target = e.currentTarget;
        var id = target.getAttribute('data-dialog');
        var dialog = document.getElementById(id);console.log(target, id, dialog)
        if (dialog) {
          dialog.open();
        }
      },
      
      /**
       * Creates an Event and stores it in the DB
       *
       */
      handleCreateEvent: function(e) {
        console.log('page-events.handleCreateEvent()', e.detail);
        if(e.detail) {
          // this.$.eventCollection.add(e.detail);
        }
      },
      
      /**
       * Check if events have been created
       */
      hasEvents: function(events) {
        return events.base.length > 0;
      },
      
      /**
       * Check if events have NOT been created
       */
      hasNoEvents: function(events) {
        return events.base.length == 0;
      }
      
    });
  </script>
</dom-module>